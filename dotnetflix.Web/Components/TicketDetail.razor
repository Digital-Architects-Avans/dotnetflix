@using dotnetflix.Models.Dtos
@using dotnetflix.Models.Dtos.Movie
@using dotnetflix.Models.Dtos.Show
@using SelectPdf
@using System.Globalization
@inject IJSRuntime JsRuntime


@if (Ticket == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <FluentCard Style="max-width: 600px; margin: 16px 0;">
        <QRCode Value="@($"https://localhost:7257/overview/{Ticket.Id}")" Alt="QRCode image" Icon="@base64PngIcon"/>
        <hr/>
        <h4>@MovieTitle - @StartTime - @EndTime</h4>
        <dl class="row">
            <dt class="col-xl-3 col-sm-4">Theater:</dt>
            <dd class="col-xl-9 col-sm-8">@Ticket.TheaterName - @Show.Type</dd>
            <dt class="col-xl-3 col-sm-4">Show Time:</dt>
            <dd class="col-xl-9 col-sm-8">@Ticket.ShowTime.ToString("dd-MM-yyyy - HH:mm", new CultureInfo("nl-NL"))</dd>
            <dt class="col-xl-3 col-sm-4">Seat:</dt>
            <dd class="col-xl-9 col-sm-8">Row @Ticket.RowNumber, Seat @Ticket.SeatNumber</dd>
            <dt class="col-xl-3 col-sm-4">Ticket Type:</dt>
            <dd class="col-xl-9 col-sm-8">@TicketType</dd>
            <dt class="col-xl-3 col-sm-4">Price:</dt>
            <dd class="col-xl-9 col-sm-8">@Ticket.TicketPrice.ToString(format: "C", provider: new CultureInfo("nl-NL")).Replace(".", ",")</dd>
        </dl>
        <FluentButton Appearance="Appearance.Accent" OnClick="@PrintTicket">Print ticket</FluentButton>
    </FluentCard>
}

@code {

    // Set properties te facilitate dependency injection
    [Inject] public ITicketService? TicketService { get; set; }

    // Parameter to be passed to the component
    [Parameter] public TicketDto? Ticket { get; set; }
    [Parameter] public MovieDto? Movie { get; set; }

    // Parameter to be passed to the component
    [Parameter] public ShowDto Show { get; set; } = new ShowDto();
    [Parameter] public string? MovieTitle { get; set; }
    [Parameter] public string StartTime { get; set; } = "00:00";
    [Parameter] public string EndTime { get; set; } = "00:00";
    [Parameter] public string? TicketType { get; set; }

    public string base64PngIcon = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNzA0cHgiIGhlaWdodD0iMTcycHgiIHZpZXdCb3g9IjAgMCA3MDQgMTcyIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgogICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoIiBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9Im5vbnplcm8iIHBvaW50cz0iNjUwLjE5MDI5OSA5MC4wMTE3MTg4IDY3Mi4zMTkyMDYgNTEuNzY5NTMxMiA3MDEuMzIzMTEyIDUxLjc2OTUzMTIgNjY1Ljc2NjQ3MSAxMDkuMDI1MzkxIDcwMi41MDQ3NTMgMTY4IDY3My43MTU2OSAxNjggNjUwLjUxMjU2NSAxMjguMjUzOTA2IDYyNy40MTY4NjIgMTY4IDU5OC40MTI5NTYgMTY4IDYzNS4xNTEyMzcgMTA5LjAyNTM5MSA1OTkuNzAyMDE4IDUxLjc2OTUzMTIgNjI4LjQ5MTA4MSA1MS43Njk1MzEyIj48L3BvbHlnb24+CiAgICAgICAgPHBvbHlnb24gaWQ9IlBhdGgiIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0ibm9uemVybyIgcG9pbnRzPSI1OTMuNjEwNDgyIDE2OCA1NjcuNTA2OTY2IDE2OCA1NjcuNTA2OTY2IDUxLjc2OTUzMTIgNTkzLjYxMDQ4MiA1MS43Njk1MzEyIj48L3BvbHlnb24+CiAgICAgICAgPHBhdGggZD0iTTU2NS44OTU2MzgsMjEuNTgzOTg0NCBDNTY1Ljg5NTYzOCwxNy41NzM1Njc3IDU2Ny4xNjY3OTcsMTQuMjQzNDg5NiA1NjkuNzA5MTE1LDExLjU5Mzc1IEM1NzIuMjUxNDMyLDguOTQ0MDEwNDIgNTc1Ljg4NTg3Miw3LjYxOTE0MDYyIDU4MC42MTI0MzUsNy42MTkxNDA2MiBDNTg1LjMzODk5Nyw3LjYxOTE0MDYyIDU4OC45OTEzNDEsOC45NDQwMTA0MiA1OTEuNTY5NDY2LDExLjU5Mzc1IEM1OTQuMTQ3NTkxLDE0LjI0MzQ4OTYgNTk1LjQzNjY1NCwxNy41NzM1Njc3IDU5NS40MzY2NTQsMjEuNTgzOTg0NCBDNTk1LjQzNjY1NCwyNS41MjI3ODY1IDU5NC4xNDc1OTEsMjguNzk5MTUzNiA1OTEuNTY5NDY2LDMxLjQxMzA4NTkgQzU4OC45OTEzNDEsMzQuMDI3MDE4MiA1ODUuMzM4OTk3LDM1LjMzMzk4NDQgNTgwLjYxMjQzNSwzNS4zMzM5ODQ0IEM1NzUuODg1ODcyLDM1LjMzMzk4NDQgNTcyLjI1MTQzMiwzNC4wMjcwMTgyIDU2OS43MDkxMTUsMzEuNDEzMDg1OSBDNTY3LjE2Njc5NywyOC43OTkxNTM2IDU2NS44OTU2MzgsMjUuNTIyNzg2NSA1NjUuODk1NjM4LDIxLjU4Mzk4NDQgWiIgaWQ9IlBhdGgiIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0ibm9uemVybyI+PC9wYXRoPgogICAgICAgIDxwYXRoIGQ9Ik01MjQuNDYyMzA1LDIzLjczMjQyMTkgQzUxNy4xNTc2MTcsMjIuNzI5ODE3NyA1MTAuODU1NTM0LDIyLjIyODUxNTYgNTA1LjU1NjA1NSwyMi4yMjg1MTU2IEM0OTEuNTE5NTk2LDIyLjIyODUxNTYgNDg0LjUwMTM2NywyOC44MTcwNTczIDQ4NC41MDEzNjcsNDEuOTk0MTQwNiBMNDg0LjUwMTM2Nyw1MS43Njk1MzEyIEw1MDguMTM0MTgsNTEuNzY5NTMxMiBMNTA4LjEzNDE4LDcxLjEwNTQ2ODggTDQ4NC41MDEzNjcsNzEuMTA1NDY4OCBMNDg0LjUwMTM2NywxNjggTDQ1OC4zOTc4NTIsMTY4IEw0NTguMzk3ODUyLDcxLjEwNTQ2ODggTDQ0MC42NzMyNDIsNzEuMTA1NDY4OCBMNDQwLjY3MzI0Miw1MS43Njk1MzEyIEw0NTguMzk3ODUyLDUxLjc2OTUzMTIgTDQ1OC4zOTc4NTIsNDEuMzQ5NjA5NCBDNDU4LjQ2OTQ2NiwyOC4yNDQxNDA2IDQ2Mi4zNTQ1NTcsMTguMjAwMTk1MyA0NzAuMDUzMTI1LDExLjIxNzc3MzQgQzQ3Ny43NTE2OTMsNC4yMzUzNTE1NiA0ODguNjE5MjA2LDAuNzQ0MTQwNjI1IDUwMi42NTU2NjQsMC43NDQxNDA2MjUgQzUxMS4zOTI2NDMsMC43NDQxNDA2MjUgNTI3LjM2MjY5NSwyLjQ2Mjg5MDYyIDU1MC41NjU4Miw1LjkwMDM5MDYyIEw1NTAuNTY1ODIsMTY4IEw1MjQuNDYyMzA1LDE2OCBMNTI0LjQ2MjMwNSwyMy43MzI0MjE5IFoiIGlkPSJQYXRoIiBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9Im5vbnplcm8iPjwvcGF0aD4KICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJub256ZXJvIiBwb2ludHM9IjM2NS42Mzc2NzYgMTY4IDM2NS42Mzc2NzYgMjMuNTkxMjUgMzE0LjE1NzY3NiAyMy41OTEyNSAzMTQuMTU3Njc2IDAgNDQzLjA4MjY3NiAwIDQ0My4wODI2NzYgMjMuNTkxMjUgMzkxLjYwMjY3NiAyMy41OTEyNSAzOTEuNjAyNjc2IDE2OCI+PC9wb2x5Z29uPgogICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoIiBmaWxsPSIjMDAwMDAwIiBmaWxsLXJ1bGU9Im5vbnplcm8iIHBvaW50cz0iMTk2LjUyODI1MiAxNjggMTk2LjUyODI1MiAwIDMwMi4yNTk1MDIgMCAzMDIuMjU5NTAyIDIzLjU5MTI1IDIyMi40OTcwMDIgMjMuNTkxMjUgMjIyLjQ5NzAwMiA3MS42NTEyNSAyOTUuNTM5NTAyIDcxLjY1MTI1IDI5NS41Mzk1MDIgOTUuMjQyNSAyMjIuNDk3MDAyIDk1LjI0MjUgMjIyLjQ5NzAwMiAxNDQuNDA4NzUgMzAzLjUzMDc1MiAxNDQuNDA4NzUgMzAzLjUzMDc1MiAxNjgiPjwvcG9seWdvbj4KICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzAwMDAwMCIgZmlsbC1ydWxlPSJub256ZXJvIiBwb2ludHM9IjU1LjQ4NDE5OTIgMTY4IDU1LjQ4NDE5OTIgMCAxMDUuMzEwNDQ5IDAgMTUxLjAxNTQ0OSAxNTAuNzY4NzUgMTU0LjgzMjk0OSAxNTAuNzY4NzUgMTU0LjgzMjk0OSAwIDE4MC40ODY2OTkgMCAxODAuNDg2Njk5IDE2OCAxMzAuNjY0MTk5IDE2OCA4NC45NTU0NDkyIDE3LjE0ODc1IDgxLjE0MTY5OTIgMTcuMTQ4NzUgODEuMTQxNjk5MiAxNjgiPjwvcG9seWdvbj4KICAgICAgICA8cGF0aCBkPSJNMTkuNzY5ODI0MiwxNzEuMzYgQzE0LjE1NzMyNDIsMTcxLjM2IDkuNDcyOTQ5MjIsMTY5LjUyMTg3NSA1LjcxNjY5OTIyLDE2NS44NDU2MjUgQzEuOTYwNDQ5MjIsMTYyLjE2OTM3NSAwLjA4MjMyNDIxODgsMTU3LjQ2IDAuMDgyMzI0MjE4OCwxNTEuNzE3NSBDMC4wODIzMjQyMTg4LDE0NS45NzI1IDEuOTYwNDQ5MjIsMTQxLjI3Mzc1IDUuNzE2Njk5MjIsMTM3LjYyMTI1IEM5LjQ3Mjk0OTIyLDEzMy45Njg3NSAxNC4xNTczMjQyLDEzMi4xNDI1IDE5Ljc2OTgyNDIsMTMyLjE0MjUgQzI1LjM4MjMyNDIsMTMyLjE0MjUgMzAuMDQwNDQ5MiwxMzMuOTgwNjI1IDMzLjc0NDE5OTIsMTM3LjY1Njg3NSBDMzcuNDQ3OTQ5MiwxNDEuMzMzMTI1IDM5LjI5OTgyNDIsMTQ2LjA0Mzc1IDM5LjI5OTgyNDIsMTUxLjc4ODc1IEMzOS4yOTk4MjQyLDE1Ny41MzEyNSAzNy40NDc5NDkyLDE2Mi4yMjg3NSAzMy43NDQxOTkyLDE2NS44ODEyNSBDMzAuMDQwNDQ5MiwxNjkuNTMzNzUgMjUuMzgyMzI0MiwxNzEuMzYgMTkuNzY5ODI0MiwxNzEuMzYgWiIgaWQ9IlBhdGgiIGZpbGw9IiMwMDAwMDAiIGZpbGwtcnVsZT0ibm9uemVybyI+PC9wYXRoPgo8L3N2Zz4=";

    protected override async Task OnInitializedAsync()
    {
        if (Ticket != null && Movie != null)
        {
            // Set movie title
            MovieTitle = Show.SneakPreview ? "Sneak preview" : Movie.Title + " (" + Movie.Year + ")";
            // Convert date to time in 24-hour format
            StartTime = Show.Date.ToString("HH:mm");
            // Get end time by adding screen time to start time
            EndTime = Show.Date.AddMinutes(Show.ScreenTime).ToString("HH:mm");

            // Get ticket type
            if (TicketService != null)
            {
                var ticketTypes = await TicketService.GetTicketTypes();
                if (ticketTypes != null) TicketType = ticketTypes.FirstOrDefault(t => t.Id == Ticket.TicketTypeId)?.Name;
            }
        }
    }

    private async Task PrintTicket()
    {
        var jsPdf = await JsRuntime.InvokeAsync<IJSObjectReference>("eval", "new window.jsPDF()");
        await jsPdf.InvokeVoidAsync("text", $"Ticket for {MovieTitle} at {Show.Date}", 10, 10);
        await jsPdf.InvokeVoidAsync("text", $"Theater: {Ticket!.TheaterName} - {Show.Type}", 10, 20);
        await jsPdf.InvokeVoidAsync("text", $"Show Time: {Ticket.ShowTime}", 10, 30);
        await jsPdf.InvokeVoidAsync("text", $"Seat: Row {Ticket.RowNumber}, Seat {Ticket.SeatNumber}", 10, 40);
        await jsPdf.InvokeVoidAsync("text", $"Ticket Type: {Ticket.TicketTypeId}", 10, 50);
        await jsPdf.InvokeVoidAsync("text", $"Price: {Ticket.TicketPrice}", 10, 60);
        await jsPdf.InvokeVoidAsync("save", "ticket.pdf");
    }

}