@page "/manager/movies"
@using System.Net.Http
@using System.Net.Http.Json
@using dotnetflix.Models.Dtos.Movie
@inject HttpClient Http
<h3>Manager: Movies</h3>

<NavigationHeader />

<div class="row">
    <div class="col-md-6">
       <table class="table">
                   <thead>
                       <tr>
                           <th>Movie titles</th>
                       </tr>
                   </thead>
                   <tbody>
                       @foreach (var movie in Movies)
                              {
                                  <tr @onclick="() => SelectMovie(movie)" class="@(SelectedMovie.Id == movie.Id ? "selected-movie" : "new-movie")">
                                      <td>@movie.Title</td>
                                  </tr> 
                              }
                       <tr @onclick="() => SelectMovie()" class="new-movie">
                           <td>Add New Movie</td>
                            </tr>
                   </tbody>
               </table>
    </div>
    <div class="col-md-6">
        @if (SelectedMovie.Id < 1)
        {
            <h4>Add New Movie</h4>
            <EditForm Model="NewMovie" OnValidSubmit="HandleAddNewMovieSubmit">
                <DataAnnotationsValidator/>
                <ValidationSummary/>

                <div class="form-group">
                    <label for="title">Title</label>
                    <InputText id="title" class="form-control" @bind-Value="NewMovie.Title"/>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <InputNumber id="year" class="form-control" @bind-Value="NewMovie.Year"/>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <InputText id="description" class="form-control" @bind-Value="NewMovie.Description"/>
                </div>
                <div class="form-group">
                    <label for="rating">Rating</label>
                    <InputSelect id="rating" class="form-control" @bind-Value="NewMovie.Rating">
                        @foreach (var rating in Enum.GetValues(typeof(Rating)))
                        {
                            <option value="@rating">@rating</option>
                        }
                    </InputSelect>
                </div>
                <div class="form-group">
                    <label for="runtime">Runtime</label>
                    <InputNumber id="runtime" class="form-control" @bind-Value="NewMovie.Runtime"/>
                </div>
                <div class="form-group">
                    <label for="image">Image</label>
                    <InputText id="image" class="form-control" @bind-Value="NewMovie.Image"/>
                </div>
                <button type="submit" class="btn btn-primary">Add</button>
            </EditForm>
        }
else
{
    <h4>Update Movie</h4>
    <EditForm Model="SelectedMovie" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator/>
        <ValidationSummary/>

        <div class="form-group">
            <label for="title">Title</label>
            <InputText id="title" class="form-control" @bind-Value="SelectedMovie.Title"/>
        </div>
        <div class="form-group">
            <label for="year">Year</label>
            <InputNumber id="year" class="form-control" @bind-Value="SelectedMovie.Year"/>
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <InputText id="description" class="form-control" @bind-Value="SelectedMovie.Description"/>
        </div>
        <div class="form-group">
            <label for="rating">Rating</label>
            <InputSelect id="rating" class="form-control" @bind-Value="SelectedMovie.Rating">
                @foreach (var rating in Enum.GetValues(typeof(Rating)))
                {
                    <option value="@rating">@rating</option>
                }
            </InputSelect>
        </div>
        <div class="form-group">
            <label for="runtime">Runtime</label>
            <InputNumber id="runtime" class="form-control" @bind-Value="SelectedMovie.Runtime"/>
        </div>
        <div class="form-group">
            <label for="image">Image</label>
            <InputText id="image" class="form-control" @bind-Value="SelectedMovie.Image"/>
        </div>
        <button type="submit" class="btn btn-primary">Update</button>
    </EditForm>
    <button class="btn btn-danger" @onclick="HandleDeleteSubmit">Delete</button>

}
    </div>
</div>

@code {
    List<MovieDto> Movies = new List<MovieDto>();
    MovieDto SelectedMovie = new MovieDto();
    AddMovieDto NewMovie = new AddMovieDto();

    private async Task HandleAddNewMovieSubmit()
    {
        var response = await Http.PostAsJsonAsync("http://localhost:5247/api/movie", NewMovie);

        if (response.IsSuccessStatusCode)
        {
            // Refresh the movie list from the database
            Movies = await Http.GetFromJsonAsync<List<MovieDto>>("http://localhost:5247/api/movie");
        }
        else
        {
            // Handle error here, e.g., show an error message
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Movies = await Http.GetFromJsonAsync<List<MovieDto>>("http://localhost:5247/api/movie");
        SelectedMovie = new MovieDto();
        NewMovie = new AddMovieDto();
    }
    
    private void SelectMovie(MovieDto movie)
    {
        // Create a copy of the selected movie
        SelectedMovie = new MovieDto
        {
            Id = movie.Id,
            Title = movie.Title,
            Year = movie.Year,
            Description = movie.Description,
            Rating = movie.Rating,
            Runtime = movie.Runtime,
            Image = movie.Image
        };
    }
    
    private void SelectMovie()
    {
        SelectedMovie = new MovieDto()
        {
            Id = 0
        };
    }


    private async Task HandleValidSubmit()
    {
        var response = await Http.PutAsJsonAsync($"http://localhost:5247/api/movie/{SelectedMovie.Id}", SelectedMovie);

        if (response.IsSuccessStatusCode)
        {
            // Find the updated movie in the list and replace it with the updated movie
            var index = Movies.FindIndex(m => m.Id == SelectedMovie.Id);
            if (index != -1)
            {
                Movies[index] = SelectedMovie;
            }
        }
        else
        {
            // Handle error here, e.g., show an error message
        }
    }
    
    private async Task HandleDeleteSubmit()
    {
        var response = await Http.DeleteAsync($"http://localhost:5247/api/movie/{SelectedMovie.Id}");

        if (response.IsSuccessStatusCode)
        {
            // Remove the deleted movie from the list
            Movies.RemoveAll(m => m.Id == SelectedMovie.Id);
            // Reset the selected movie
            SelectedMovie = new MovieDto();
        }
        else
        {
            // Handle error here, e.g., show an error message
        }
    }
}

<style>
    /*.table tbody tr:nth-child(odd) {*/
    /*    background-color: rgba(242, 242, 242, 0.5);*/
    /*}*/
    .selected-movie {
            background-color: #007bff;
            color: white;
        }
</style>